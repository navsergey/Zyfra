<div class="app-wrapper">
    <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
    <app-sidebar-component
      [contexts]="contexts"
      [selectedContextId]="selectedContextId"
      [pendingRequestContextIds]="pendingRequestContextIds"
      (contextSelected)="onContextSelected($event)"
      (contextDeleted)="onContextDeleted($event)">
    </app-sidebar-component>
    <!-- –ü—Ä–∞–≤–∞—è –æ–±–ª–∞—Å—Ç—å -->
    <main class="chat-area">
        <header class="top-bar">
            <h1 class="chat-title">–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç <span>–¶–∏—Ñ—Ä—ã</span></h1>
            <div class="status-indicator">
                <div class="status-dot" [class.healthy]="healthStatus === 'healthy'" [class.unhealthy]="healthStatus !== 'healthy'"></div>
                <span>{{ healthStatus === 'healthy' ? '–û–Ω–ª–∞–π–Ω' : '–û—Ñ—Ñ–ª–∞–π–Ω' }}</span>
            </div>
        </header>

        <div class="messages-area" id="chatMessages">
            <!-- –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π —ç–∫—Ä–∞–Ω -->
            <div class="welcome-container" id="welcomeView" *ngIf="showWelcome">
                <div class="welcome-graphic"></div>
                <h2 class="welcome-heading">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ <span class="highlight">–¶–∏—Ñ—Ä–∞ GPT</span></h2>
                <p class="welcome-description">
                    –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è –∏–Ω–¥—É—Å—Ç—Ä–∏–∞–ª—å–Ω–æ–≥–æ —Å–µ–∫—Ç–æ—Ä–∞.
                    –ü–æ–º–æ–≥–∞—é —Å —Ü–∏—Ñ—Ä–æ–≤–∏–∑–∞—Ü–∏–µ–π –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞, –∞–Ω–∞–ª–∏–∑–æ–º –¥–∞–Ω–Ω—ã—Ö –∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–µ–π –ø—Ä–æ—Ü–µ—Å—Å–æ–≤.
                </p>
                <div class="prompts-grid">
                    <div class="prompt-card">
                        <div class="prompt-icon">üìä</div>
                        <div class="prompt-label">–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</div>
                        <div class="prompt-description">–ö–∞–∫ –ø–æ–≤—ã—Å–∏—Ç—å —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞ —Å –ø–æ–º–æ—â—å—é IoT?</div>
                    </div>
                    <div class="prompt-card">
                        <div class="prompt-icon">‚öôÔ∏è</div>
                        <div class="prompt-label">–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ ZIIoT</div>
                        <div class="prompt-description">–†–∞—Å—Å–∫–∞–∂–∏ –æ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ ZIIoT –¥–ª—è –Ω–µ—Ñ—Ç–µ–≥–∞–∑–∞</div>
                    </div>
                    <div class="prompt-card">
                        <div class="prompt-icon">‚õèÔ∏è</div>
                        <div class="prompt-label">–ì–æ—Ä–Ω–∞—è –æ—Ç—Ä–∞—Å–ª—å</div>
                        <div class="prompt-description">–ö–∞–∫–∏–µ —Ä–µ—à–µ–Ω–∏—è –¥–ª—è –≥–æ—Ä–Ω–æ–π –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ—Å—Ç–∏?</div>
                    </div>
                    <div class="prompt-card">
                        <div class="prompt-icon">ü§ñ</div>
                        <div class="prompt-label">–†–æ–±–æ—Ç–∏–∑–∞—Ü–∏—è</div>
                        <div class="prompt-description">–ö–∞–∫ –≤–Ω–µ–¥—Ä–∏—Ç—å —Ä–æ–±–æ—Ç–∏–∑–∞—Ü–∏—é –Ω–∞ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–∏?</div>
                    </div>
                </div>
            </div>

            <!-- –°–æ–æ–±—â–µ–Ω–∏—è —á–∞—Ç–∞ -->
            <div class="chat-message" [class.user]="message.sender === 'user'" [class.assistant]="message.sender === 'assistant'" *ngFor="let message of chatHistory$ | async">
                <div class="message-icon">{{ getMessageIcon(message.sender) }}</div>
                <div class="message-body">
                    <div class="message-bubble" [innerHTML]="formatMessageText(message.text)"></div>
                    <div class="message-timestamp" *ngIf="message.sender === 'assistant'&& selectedContextId">{{ formatTimestamp(message.ts) }}</div>

                    <!-- –ò–∫–æ–Ω–∫–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –¥–ª—è –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ -->
                    <div class="source-icons" *ngIf="message.sender === 'assistant' && message.sources && message.sources.length > 0">
                        <a *ngFor="let source of message.sources"
                           [href]="source.url"
                           target="_blank"
                           rel="noopener noreferrer"
                           class="source-icon-link"
                           [title]="source.filename + ' - —Å—Ç—Ä–∞–Ω–∏—Ü—ã: ' + formatPages(source.pages)">
                            <div class="source-icon">
                                <svg viewBox="0 0 24 24" width="18" height="18">
                                    <path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/>
                                </svg>
                                <span class="source-pages">{{ formatPages(source.pages) }}</span>
                            </div>
                        </a>
                    </div>

                    <!-- –ö–Ω–æ–ø–∫–∏ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ –¥–ª—è –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ -->
                    <div class="feedback-buttons" *ngIf="message.sender === 'assistant' && message.turn_index !== undefined && message.context_id">
                        <button class="feedback-btn like-btn"
                                (click)="sendFeedback(message.context_id!, message.turn_index!, 'like')"
                                title="–ü–æ–ª–µ–∑–Ω—ã–π –æ—Ç–≤–µ—Ç">
                            <svg viewBox="0 0 24 24" width="16" height="16">
                                <path d="M1 21h4V9H1v12zm22-11c0-1.1-.9-2-2-2h-6.31l.95-4.57.03-.32c0-.41-.17-.79-.44-1.06L14.17 1 7.59 7.59C7.22 7.95 7 8.45 7 9v10c0 1.1.9 2 2 2h9c.83 0 1.54-.5 1.84-1.22l3.02-7.05c.09-.23.14-.47.14-.73v-2z"/>
                            </svg>
                        </button>
                        <button class="feedback-btn dislike-btn"
                                (click)="sendFeedback(message.context_id!, message.turn_index!, 'dislike')"
                                title="–ù–µ –ø–æ–º–æ–≥">
                            <svg viewBox="0 0 24 24" width="16" height="16">
                                <path d="M15 3H6c-.83 0-1.54.5-1.84 1.22l-3.02 7.05c-.09.23-.14.47-.14.73v2c0 1.1.9 2 2 2h6.31l-.95 4.57-.03.32c0 .41.17.79.44 1.06L9.83 23l6.59-6.59c.36-.36.58-.86.58-1.41V5c0-1.1-.9-2-2-2zm4 0v12h4V3h-4z"/>
                            </svg>
                        </button>
                        <button class="feedback-btn copy-btn"
                                (click)="copyMessage(message.text)"
                                title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç">
                            <svg viewBox="0 0 24 24" width="16" height="16">
                                <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
            <div class="chat-message assistant loading-message" *ngIf="hasActiveRequest(selectedContextId)" @fadeInOut>
                <div class="message-icon">AI</div>
                <div class="message-body">
                    <div class="message-bubble loading-bubble">
                        <div class="typing-indicator">
                            <span class="dot"></span>
                            <span class="dot"></span>
                            <span class="dot"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer class="input-container">
            <div class="input-box-wrapper">
                <textarea
                    class="text-input"
                    id="userInput"
                    placeholder="–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –æ —Ü–∏—Ñ—Ä–æ–≤–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ—Å—Ç–∏..."
                    rows="1"
                    [(ngModel)]="userInput"
                    (keydown)="checkEnter($event)"
                    (input)="adjustHeight($event)"
                    [disabled]="hasActiveRequest(selectedContextId)"></textarea>
                <select
                    class="version-select"
                    [(ngModel)]="selectedVersion"
                    (change)="onVersionChange()"
                    [disabled]="hasActiveRequest(selectedContextId)">
                    <option value="ZIOT_DOCS_217">–ó–ò–û–¢ 2.17</option>
                    <option value="ZIOT_DOCS_218">–ó–ò–û–¢ 2.18</option>
                    <option value="ZIOT_DOCS_219">–ó–ò–û–¢ 2.19</option>
                    <option value="ZIOT_DOCS_220">–ó–ò–û–¢ 2.20</option>
                </select>
                <button class="btn-send"
                        (click)="submitMessage()"
                        [disabled]="hasActiveRequest(selectedContextId)">
                    <svg class="send-svg" viewBox="0 0 24 24">
                        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                    </svg>
                </button>
            </div>
        </footer>
    </main>
</div>
