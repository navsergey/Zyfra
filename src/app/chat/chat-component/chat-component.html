<div class="app-wrapper">
    <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
    <app-sidebar-component
      [contexts]="contexts"
      [selectedContextId]="selectedContextId"
      [pendingRequestContextIds]="pendingRequestContextIds"
      [showWelcome]="showWelcome"
      [isRequestPending]="isRequestPending"
      (contextSelected)="onContextSelected($event)"
      (contextDeleted)="onContextDeleted($event)"
      (newChat)="onNewChat()">
    </app-sidebar-component>
    <!-- –ü—Ä–∞–≤–∞—è –æ–±–ª–∞—Å—Ç—å -->
    <main class="chat-area">
        <header class="top-bar">
            <h1 class="chat-title">–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç <span>–¶–∏—Ñ—Ä—ã</span></h1>
            <div class="status-indicator">
                <div class="status-dot" [class.healthy]="healthStatus === 'healthy'" [class.unhealthy]="healthStatus !== 'healthy'"></div>
                <span>{{ healthStatus === 'healthy' ? '–û–Ω–ª–∞–π–Ω' : '–û—Ñ—Ñ–ª–∞–π–Ω' }}</span>
            </div>
        </header>

        <div class="messages-area" id="chatMessages">
            <!-- –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π —ç–∫—Ä–∞–Ω -->
            <div class="welcome-container" id="welcomeView" *ngIf="showWelcome">
                <div class="welcome-graphic"></div>
                <h2 class="welcome-heading">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ <span class="highlight">–¶–∏—Ñ—Ä–∞ GPT</span></h2>
                <p class="welcome-description">
                  –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –¶–∏—Ñ—Ä—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤ –ø–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º –±–∞–∑–∞–º –∑–Ω–∞–Ω–∏–π!.
                  –ü—Ä–æ–µ–∫—Ç —Ä–∞–∑–≤–∏–≤–∞–µ—Ç—Å—è –Ω–∞ —ç–Ω—Ç—É–∑–∏–∞–∑–º–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –£—á–µ–±–Ω–æ–≥–æ —Ü–µ–Ω—Ç—Ä–∞ –¶–∏—Ñ—Ä—ã –ø—Ä–∏ –ø–æ–¥–¥–µ—Ä–∂–∫–µ –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∞ –ì–ö –¶–∏—Ñ—Ä–∞.
                  –≠—Ç–æ –∞–ª—å—Ñ–∞ –≤–µ—Ä—Å–∏—è –±–æ—Ç–∞, –æ–Ω–∞ –º–æ–∂–µ—Ç –¥–∞–≤–∞—Ç—å –Ω–µ —Ç–æ—á–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã, —Å–æ–¥–µ—Ä–∂–∞—Ç—å –±–∞–≥–∏ –∏ –Ω–µ–¥–æ—Ä–∞–±–æ—Ç–∫–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞. –û–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å –≤—ã –º–æ–∂–µ—Ç–µ –æ—Å—Ç–∞–≤–∏—Ç—å —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –≤—ã–∑–æ–≤–∞ –¢–ü. –¢–∞–∫–∂–µ –º–æ–∂–µ—Ç–µ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –Ω–æ–≤—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π –±–æ—Ç–∞.
                </p>
                <div class="prompts-grid">
                    <div class="prompt-card prompt-card-clickable" (click)="submitMessage('–£ –º–µ–Ω—è –≤–æ–ø—Ä–æ—Å –ø–æ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ ZIIoT', 'ziiot')">
                        <div class="prompt-icon">üåê</div>
                        <div class="prompt-label">–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ ZIIoT</div>
                        <div class="prompt-description">–í —ç—Ç–æ–π –≤–µ—Ç–∫–µ –±–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ø–æ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ ZIIoT. –í –æ—Ç–≤–µ—Ç–∞—Ö –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–æ–¥—É–∫—Ç–æ–≤–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è (—É –Ω–µ–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç) –∏ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π –≤ Confluence</div>
                    </div>
                    <div class="prompt-card prompt-card-clickable" (click) = "submitMessage('–†–∞—Å—Å–∫–∞–∂–∏ –ø—Ä–æ –ø—Ä–æ–¥—É–∫—Ç –¶–∏—Ñ—Ä–∞. –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä MES', 'ziak')" >
                        <div class="prompt-icon">üß©</div>
                        <div class="prompt-label">–¶–∏—Ñ—Ä–∞. –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä MES (ZIAK)</div>
                        <div class="prompt-description">–í —ç—Ç–æ–π –≤–µ—Ç–∫–µ –±–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ø–æ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä—É MES (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º –≤ –≤–æ–ø—Ä–æ—Å–∞—Ö –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–±–±—Ä–µ–≤–∏–∞—Ç—É—Ä—É ZIAK). –í –æ—Ç–≤–µ—Ç–∞—Ö –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–æ–¥—É–∫—Ç–æ–≤–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∏ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π –≤ Confluence</div>
                    </div >
                    <div class="prompt-card prompt-card-clickable" (click) = "submitMessage('–£ –º–µ–Ω—è –≤–æ–ø—Ä–æ—Å –∫ –ø–æ–º–æ—â–Ω–∏–∫—É –ø–æ –ø–æ–∏—Å–∫—É –ø–æ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞–º–∏', 'projectmgmt')" >
                        <div class="prompt-icon">üìã</div>
                        <div class="prompt-label">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞–º–∏ –ù–ü</div>
                        <div class="prompt-description">–í —ç—Ç–æ–π –≤–µ—Ç–∫–µ –±–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ø–æ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞–º–∏ –¥–∏–≤–∏–∑–∏–æ–Ω–∞ –ù–ü –≤ Confluence</div>
                    </div >
                    <div class="prompt-card prompt-card-clickable" (click) = "submitMessage('–£ –º–µ–Ω—è –≤–æ–ø—Ä–æ—Å –∫ –ø–æ–º–æ—â–Ω–∏–∫—É –ø–æ –ø–æ–∏—Å–∫—É –ø–æ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤', 'autobp')" >
                        <div class="prompt-icon">ü§ñ</div>
                        <div class="prompt-label">–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –±–∏–∑–Ω–µ—Å –ø—Ä–æ—Ü–µ—Å—Å–æ–≤</div>
                        <div class="prompt-description">–í —ç—Ç–æ–π –≤–µ—Ç–∫–µ –±–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ø–æ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π "–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –ë–ü" –≤ Confluence. –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å –ø–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º –ø—Ä–æ—Ü–µ—Å—Å–∞–º –∏ —Ä–µ–≥–ª–∞–º–µ–Ω—Ç–∞–º –ì–ö –¶–∏—Ñ—Ä–∞</div>
                    </div >
                    <div class="prompt-card prompt-card-clickable prompt-card-special" (click) = "openOfferSourceModal()" >
                        <div class="prompt-icon">üí°</div>
                        <div class="prompt-label">–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫</div>
                        <div class="prompt-description">–ï—Å–ª–∏ –±–æ—Ç –Ω–µ –¥–∞–ª –æ—Ç–≤–µ—Ç –Ω–∞ –í–∞—à –≤–æ–ø—Ä–æ—Å, –Ω–æ –≤—ã –∑–Ω–∞–µ—Ç–µ, –≥–¥–µ –æ–Ω —Å–æ–¥–µ—Ä–∂–∏—Ç—Å—è (Confluence, Nextcloud, –ë–∏—Ç—Ä–∏–∫—Å –∏ —Ç.–¥.) - –ø—Ä–∏—à–ª–∏—Ç–µ –Ω–∞–º —Å—Å—ã–ª–∫—É –∏ –º—ã –ø–æ–¥–∫–ª—é—á–∏–º –µ–µ –∫ –±–æ—Ç—É! –ü–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π –≤ –±–æ—Ç–∞ –≤—Å–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –æ–±–µ–∑–ª–∏—á–∏–≤–∞—é—Ç—Å—è –∏ —á–∏—Å—Ç—è—Ç—Å—è –æ—Ç —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.</div>
                    </div >
                    <div class="prompt-card prompt-card-special" (click) = "submitMessage('–ö–∞–∫ –Ω–∞–ø–∏—Å–∞—Ç—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É', 'ziiot')" >
                        <div class="prompt-icon">üõ†Ô∏è</div>
                        <div class="prompt-label">–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞</div>
                        <div class="prompt-description">–°–≤—è–∑–∞—Ç—å—Å—è —Å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π</div>
                    </div >
                </div >
            </div>

            <!-- –°–æ–æ–±—â–µ–Ω–∏—è —á–∞—Ç–∞ -->
            <div class="chat-message" [class.user]="message.sender === 'user'" [class.assistant]="message.sender === 'assistant'" *ngFor="let message of chatHistory$ | async">
                <div class="message-icon">{{ getMessageIcon(message.sender) }}</div>
                <div class="message-body">
                    <div class="message-bubble" [innerHTML]="formatMessageText(message.text)"></div>
                    <div class="message-timestamp" *ngIf="message.sender === 'assistant'&& selectedContextId">{{ formatTimestamp(message.ts) }}</div>

                    <!-- –ò–∫–æ–Ω–∫–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –¥–ª—è –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ -->
                    <div class="source-icons" *ngIf="message.sender === 'assistant' && message.sources && message.sources.length > 0">
                        <a *ngFor="let source of message.sources"
                           [href]="source.url"
                           target="_blank"
                           rel="noopener noreferrer"
                           class="source-icon-link"
                           [title]="source.filename ? removeExtension(source.filename) : '–î–æ–∫—É–º–µ–Ω—Ç' + (source.pages && source.pages.length ? ' - —Å—Ç—Ä–∞–Ω–∏—Ü—ã: ' + formatPages(source.pages) : '')">
                            <div class="source-icon">
                                <svg viewBox="0 0 24 24" width="18" height="18">
                                    <path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/>
                                </svg>
                                <span class="source-pages">{{ source.pages && source.pages.length ? formatPages(source.pages) : (source.filename ? shortenFileName(source.filename) : '–î–æ–∫—É–º–µ–Ω—Ç') }}</span>
                            </div>
                        </a>
                    </div>

                    <!-- –ö–Ω–æ–ø–∫–∏ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ –¥–ª—è –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ -->
                    <div class="feedback-buttons" *ngIf="message.sender === 'assistant' && message.turn_index !== undefined && message.context_id">
                        <button class="feedback-btn like-btn"
                                [class.active]="message.feedback_type === 'like'"
                                (click)="sendFeedback(message.context_id!, message.turn_index!, 'like')"
                                title="–ü–æ–ª–µ–∑–Ω—ã–π –æ—Ç–≤–µ—Ç">
                            <svg viewBox="0 0 24 24" width="16" height="16">
                                <path d="M1 21h4V9H1v12zm22-11c0-1.1-.9-2-2-2h-6.31l.95-4.57.03-.32c0-.41-.17-.79-.44-1.06L14.17 1 7.59 7.59C7.22 7.95 7 8.45 7 9v10c0 1.1.9 2 2 2h9c.83 0 1.54-.5 1.84-1.22l3.02-7.05c.09-.23.14-.47.14-.73v-2z"/>
                            </svg>
                        </button>
                        <button class="feedback-btn dislike-btn"
                                [class.active]="message.feedback_type === 'dislike'"
                                (click)="sendFeedback(message.context_id!, message.turn_index!, 'dislike')"
                                title="–ù–µ –ø–æ–º–æ–≥">
                            <svg viewBox="0 0 24 24" width="16" height="16">
                                <path d="M15 3H6c-.83 0-1.54.5-1.84 1.22l-3.02 7.05c-.09.23-.14.47-.14.73v2c0 1.1.9 2 2 2h6.31l-.95 4.57-.03.32c0 .41.17.79.44 1.06L9.83 23l6.59-6.59c.36-.36.58-.86.58-1.41V5c0-1.1-.9-2-2-2zm4 0v12h4V3h-4z"/>
                            </svg>
                        </button>
                        <button class="feedback-btn copy-btn"
                                (click)="copyMessage(message.text)"
                                title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç">
                            <svg viewBox="0 0 24 24" width="16" height="16">
                                <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
            <div class="chat-message assistant loading-message" *ngIf="hasLoadingIndicator(selectedContextId)" @fadeInOut>
                <div class="message-icon">AI</div>
                <div class="message-body">
                    <div class="message-bubble loading-bubble">
                        <div class="typing-indicator">
                            <span class="dot"></span>
                            <span class="dot"></span>
                            <span class="dot"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="input-container" *ngIf="!showWelcome">
            <div class="input-box-wrapper">
                <button class="web-search-btn"
                        *ngIf="currentSource === 'ziiot' || currentSource === 'ziak'"
                        [class.active]="webSearchActive"
                        (click)="toggleWebSearch()"
                        [disabled]="hasActiveRequest(selectedContextId)"
                        title="–í–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å –ø–æ–∏—Å–∫ –ø–æ –æ–±—â–∏–º –∑–Ω–∞–Ω–∏—è–º –æ–± opensource —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è—Ö">
                    <span class="globe-icon">üåê</span>
                </button>
                <textarea
                    class="text-input"
                    id="userInput"
                    placeholder="–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å"
                    rows="1"
                    [(ngModel)]="userInput"
                    (keydown)="checkEnter($event)"
                    (input)="adjustHeight($event)"
                    [disabled]="hasActiveRequest(selectedContextId)"></textarea>
                <select
                    *ngIf="currentSource === 'ziiot' || currentSource === ''"
                    class="version-select"
                    [(ngModel)]="selectedVersion"
                    (change)="onVersionChange()"
                    [disabled]="hasActiveRequest(selectedContextId)">
                    <option *ngFor="let option of versionOptions" [value]="option.key">
                        {{ option.displayName }}
                    </option>
                </select>
                <button class="btn-send"
                        (click)="submitMessage()"
                        [disabled]="hasActiveRequest(selectedContextId)">
                    <svg class="send-svg" viewBox="0 0 24 24">
                        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                    </svg>
                </button>
            </div>
        </div>
    </main>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–∞ -->
    <div class="modal-overlay" *ngIf="showOfferSourceModal" (click)="closeOfferSourceModal()">
        <div class="modal-content" (click)="$event.stopPropagation()">
            <button class="modal-close-btn" (click)="closeOfferSourceModal()">
                <svg viewBox="0 0 24 24" width="24" height="24">
                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                </svg>
            </button>
            <app-offer-source-component (close)="closeOfferSourceModal()"></app-offer-source-component>
        </div>
    </div>
</div>
